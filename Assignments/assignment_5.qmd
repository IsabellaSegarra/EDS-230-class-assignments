---
title: "EDS-230 Assignment 5: Sobol"
author: Isabella Segarra 
format:
  html:
    code-fold: show
execute:
  echo: true
  warning: false
  message: false
  error: false
---
```{r}
#| message: false 
# Set-up

library(sensitivity)
library(tidyverse)
# library(lhs)
library(purrr)
library(here)
```

## Part 1
**Snow Model Sobol Sensitivity Analysis** 
This paper analyzes the parameter sensitivity of two widely used snow models: the conceptual SNOW-17 model and the physically based snow component of the Variable Infiltration Capacity (VIC) model. Using a combined Sobolâ€™ sensitivity analysis, the study compares how parameters in each model contribute to output variance and affect prediction robustness.

The inclusion of different sites was a great way to test how sensitive the models are to varying site characteristics and to evaluate how they perform under different conditions. This showed that the VIC model had different parameter sensitivities across certain climates, suggesting that these models may struggle to be applied consistently across different microclimates and bioregions. By analyzing parameter sensitivity in both a physically based model (VIC) and a conceptual model (SNOW-17), the study highlights how model type influences which parameters matter most.

The sensitivity analysis showed that only some parameters strongly influence each model. For SNOW-17, because it is temperature-dependent, temperature and melting parameters mattered most. This helps clarify which parameters are most important when focusing on the conceptual understanding of snowmelt. For the VIC model, snow albedo and other energy-balance-related parameters were especially important, adding more insight into the physically based processes that control snowmelt. At the same time, there is also value in recognizing the parameters that control less of the output, as this helps when thinking about the broader environmental implications and applications of these models.


## Part 2: Model of Atmospheric Conductance
In this part I will use code from `lecture8_sensitivity_sobol.qmd` to model atmospheric conductance. I will source the `Catm` function and perform a sensitivity analysis to determine which parameters are most important using the Sobol method. 

### Step 1: The Function
This function was created by Naomi Tague. It is a function that calculates atmospheric conductance or how easily water diffuses into the air. This value largely depends on windspeed. 

```{r}
source(here("R/Catm.R"))
```

## Step 2: Sobol sensitivty analysis
The following parameters are considered in our sensitivity analysis:
- `height`: assume that height is somewhere between 3.5 and 5.5 m
- `k_d`: assume normal distirbution with sd of 1% of default (0.1)
- `k_o`: assume normal distirbution with sd of 1% of default (0.1)
- `v`: Windspeeds are normally distributed with a mean of 300 cm/s with a standard deviation of 50 cm/s

```{r}
#| output: false 
# Set seed for reproducibility
set.seed(230)

# Step 1: Generate two examples of random number from parameter distributions

# Define sample size 
np <- 1000

#.... X1 Sampling.... 
# Define variables 
k_o <- rnorm(mean = 0.1, sd = 0.1 * 0.01, n = np)
k_d <- rnorm(mean = 0.7, sd = 0.7 * 0.01, n = np)
v <- rnorm(mean = 300, sd = 50, n = np) # Windspeed
height <- runif(min = 3.5 , max = 5.5, n = np) # Vegetation height 
# Create dataframe 
X1 <- cbind.data.frame(k_o, k_d, v, height = height)

# ..... X2 Sampling.....
# Define variables 
k_o <- rnorm(mean = 0.1, sd = 0.1 * 0.01, n = np)
k_d <- rnorm(mean = 0.7, sd = 0.7 * 0.01, n = np)
v <- rnorm(mean = 300, sd = 50, n = np) # Windspeed
height <- runif(min = 3.5 , max = 5.5, n = np) # Vegetation height 
# Create dataframe 
X2 <- cbind.data.frame(k_o, k_d, v, height = height)

# Step 2: Run Sobol model on X1 and X2 dataframes 
sens_Catm_Sobol <- sobolSalt(model = NULL, X1, X2, nboot = 100)


# Take a look at the Sobol generated sensitivity object
sens_Catm_Sobol$X
# your parameters sets for sensitivity analysis are in X
```

## Calculate Sobol Indices
In this section I will:
1. Run Sobol model for parameter sets (`X1` and `X2`).
2. Calculate sensitivity indices
3. Create dataframe with model outputs. 
  
```{r}
#| output: false 
# Step 3: Turn Sobol generated sensitivity object into a dataframe

# Prepare parameter matrix for model runs
parms <- as.data.frame(sens_Catm_Sobol$X)
colnames(parms) <- colnames(X1)

# Run model and calculate sensitivity indices
res <- pmap_dbl(parms, Catm)
sens_Catm_Sobol <- sensitivity::tell(sens_Catm_Sobol, res, res.names = "ga")

# Extract and label main effects (first-order indices)
row.names(sens_Catm_Sobol$S) <- colnames(parms)
sens_Catm_Sobol$S

# Extract and label total effects (includes interactions)
row.names(sens_Catm_Sobol$T) <- colnames(parms)
sens_Catm_Sobol$T

# Summary of sensitivity analysis
print(sens_Catm_Sobol)

# Combine parameters with model output
both <- cbind.data.frame(parms, gs = sens_Catm_Sobol$y)
```
**Interpretation of Output**

The output for `sens_Catm_Sobol` contains the first-order indices. These values inform you how much model variance is influenced by that variable. The model output shows that windspeed (`v`) has a sobol value of 0.852 or this variable controls 85% of atmospheric conductance. The second most important variable is `height` which has a sobol value of 0.16, contributing to 16.5% of the variance in atmospheric conductance. 

## Visualizing uncertainty
In this section I will:
1. Plot conductance estimates in a way that accounts for parameter uncertainty
2. Plot conductance estimates against windspeed use the parameter that is 2nd in terms of total effect on
response

```{r}

# Distribution of conductance across parameter space
ggplot(both, aes(x = gs)) +
  geom_histogram() +
  geom_vline(xintercept = mean(both$gs), col = "hotpink") +
  labs(x = "Conductance (mm/s)", 
       title = "Distribution of Atmospheric Conductance") +
  theme_minimal()

```
```{r}
# Conductance response to windspeed (first most sensitive parameter)
ggplot(both, aes(v, gs)) +
  geom_point(alpha = 0.3) +
  geom_smooth(method = "lm") +
  labs(y = "Conductance (mm/s)",
       x = "Windspeed (m/s)", 
       title = "Atmospheric Conductance Response to Windspeed", 
       subtitle= "Sobol First-Order Indice") +
  theme_minimal()

```

```{r}
# Conductance response to height (second most sensitive)
ggplot(both, aes(height, gs)) +
  geom_point(alpha = 0.3) +
  geom_smooth(method = "loess", se = TRUE) +
  labs(x = "Height (m)",
       y = "Conductance (mm/s)", 
       title = "Atmsopheric Conductance Response to Vegetation Height", 
       subtitle = "Sobol Second-Order Indice") +
  theme_minimal()

```

```{r}
# Windpseed effect with height 
ggplot(both, aes(v, gs, col = height)) +
  geom_point(alpha = 0.5) +
  scale_color_viridis_c(option = "magma", direction = -1)+
  labs(x = "Windspeed (m/s)",
       y = "Conductance (mm/s)",
       col = "Height (m)", 
       title = "Atmospheric Conductance Response to Windspeed and Vegetation Height") +
  theme_minimal()
```
**Interpretation of plots**
The original parameter values for this model showed that `k_d` was the most sensitivity parameter, followed by `k_o`. This is interesting when compared to the current model which shows that vegetation and height had the strongest influence on atmospheric conductance. In this setting, where windspeed is stronger and vegetation is higher, you see more sensitivity to windspeed and vegetation height. Additionally, you see more of a strong linear relationship between atmospheric conductance and windspeed. In a setting with normal wind and vegetation height, `k_o` and `k_d` influence atmospheric conductance the most. This implication for modeling atmospheric conductance shows that there could be a threshold in which other parameters become less effective such as in our current model. 


